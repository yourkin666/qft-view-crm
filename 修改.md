### **系统功能修改文档：线索记录模块**

#### 1. 修改背景

为了更精细化地管理和跟进客户线索，本次系统升级将对“线索记录”功能进行重构。核心目标是丰富线索信息的维度，并根据线索的不同跟进阶段，动态展示和收集相关信息，从而提升线索转化率和数据完整性。

#### 2. 需求详述

##### 2.1. 线索录入阶段（基础信息）

在创建一条新的线索记录时，以下信息为 **必填项**:

*   **线索来源平台**: 记录线索的初始来源。
    *   选项: `企业微信`, `个人微信`, `小红书`, `闲鱼`, `抖音`, `视频号`, `贝壳`, `58同城`
*   **客户需求房源**: 客户初步表达的房屋需求类型。
    *   选项: `单间`, `两房`, `三房`
*   **客户来源房源价格**: 客户咨询的房源或其预算价格。
    *   建议字段类型: 数值型（元）
*   **当前跟进平台**: 目前主要使用哪个平台与客户沟通。
    *   选项: `企业微信`, `个人微信`, `小红书`, `闲鱼`, `抖音`, `视频号`, `贝壳`, `58同城`
*   **客户状态**: 线索的当前跟进状态。
    *   选项: `接洽中`, `已约带看`, `客户丢失`

##### 2.2. 线索跟进阶段（带看信息）

当一条线索的 **`客户状态`** 从 **`接洽中`** 变更为 **`已约带看`** 后，系统需要额外记录以下 **带看信息**:

*   **带看状态**: 记录客户的带看次数。
    *   选项: `一次带看`, `二次带看`, `三次带看`
*   **带看人**: 负责本次带看的员工。
    *   建议字段类型: 关联员工表
*   **带看日期**: 带看的具体日期和时间。
    *   建议字段类型: 日期时间（YYYY-MM-DD HH:mm）
*   **带看房源**: 本次带看的具体房源信息。
    *   **支持多选**: 允许一次带看关联多个房源。
    *   建议字段类型: 文本或JSON，记录房源编号或名称。
*   **客户反馈**: 带看后，客户的反馈和意向。
    *   建议字段类型: 长文本

#### 3. 技术实现方案概要

##### 3.1. 数据模型/数据库表变更

建议在 `clues` (线索) 表中进行如下修改：

| 字段名 (建议)             | 中文含义         | 数据类型                 | 备注                                         |
| ------------------------- | ---------------- | ------------------------ | -------------------------------------------- |
| `source_platform`         | 线索来源平台     | `VARCHAR` 或 `ENUM`      | **必填**。存储平台名称。                      |
| `customer_room_type`      | 客户需求房源     | `VARCHAR` 或 `ENUM`      | **必填**。存储'单间', '两房', '三房'。         |
| `source_property_price`   | 客户来源房源价格 | `DECIMAL(10, 2)`         | **必填**。                                   |
| `follow_up_platform`      | 当前跟进平台     | `VARCHAR` 或 `ENUM`      | **必填**。                                   |
| `status`                  | 客户状态         | `VARCHAR` 或 `ENUM`      | **必填**。'接洽中', '已约带看', '客户丢失'。  |
| `viewing_status`          | 带看状态         | `VARCHAR` 或 `ENUM`      | **非必填** (Nullable)。'一次带看' 等。       |
| `viewing_agent_id`        | 带看人ID         | `INTEGER` / `UUID`       | **非必填** (Nullable)。关联用户/员工表。    |
| `viewing_date`            | 带看日期         | `DATETIME`               | **非必填** (Nullable)。                      |
| `viewing_properties`      | 带看房源         | `JSON` 或 `TEXT`         | **非必填** (Nullable)。存储房源ID或名称数组。 |
| `customer_feedback`       | 客户反馈         | `TEXT`                   | **非必填** (Nullable)。                      |

##### 3.2. 后端 API 变更

*   **`POST /api/clues` (创建线索)**:
    *   请求体中需要包含所有基础信息字段，并进行非空校验。
*   **`PUT /api/clues/{id}` (更新线索)**:
    *   核心逻辑变更点。当 `status` 字段从 `接洽中` 更新为 `已约带看` 时，API需要能接收并处理 `viewing_status` 等带看信息字段。
    *   需要增加对带看信息字段的校验逻辑。

##### 3.3. 前端界面变更

*   **线索创建/编辑表单**:
    *   添加 “线索来源平台”、“客户需求房源” 等必填字段的输入控件（建议使用下拉选择框）。
    *   “带看信息” 部分（包括带看状态、带看人等字段）默认隐藏。
    *   **动态显示逻辑**: 当 “客户状态” 字段选择为 “已约带看” 时，动态显示 “带看信息” 的表单区域，并可能将其中部分字段（如带看状态、带看人）设为必填。

#### 4. 测试要点

1.  **创建流程**:
    *   验证所有必填项均填写后，线索可以成功创建。
    *   验证任一必填项为空时，系统会提示错误，无法创建。
2.  **更新流程**:
    *   将客户状态从 `接洽中` 修改为 `已约带看`，验证“带看信息”表单项是否正确显示。
    *   填写带看信息并保存，验证数据是否成功写入数据库。
    *   再次编辑该线索，验证带看信息是否能正确回显。
3.  **状态流转**:
    *   测试不同状态（`接洽中`, `已约带看`, `客户丢失`）之间的切换，确保UI和数据逻辑正确。
4.  **回归测试**:
    *   检查修改后，原有的线索列表查询、详情查看等功能是否正常，确保无功能损坏。 