#!/bin/bash

# =============================================================================
# QFT VIEW CRM ç®€åŒ–å¯åŠ¨è„šæœ¬
# =============================================================================
# å¿«é€Ÿå¯åŠ¨å·²é…ç½®å¥½çš„QFT CRMç³»ç»Ÿ
# =============================================================================

echo "ğŸ  å¯åŠ¨ QFT VIEW CRM ç³»ç»Ÿ..."

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/qft-view-crm

# æ£€æŸ¥ç«¯å£å ç”¨
check_ports() {
    log_info "æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ..."
    
    # æ£€æŸ¥3001ç«¯å£ï¼ˆåç«¯APIï¼‰
    if lsof -i :3001 >/dev/null 2>&1; then
        log_warning "ç«¯å£ 3001 å·²è¢«å ç”¨ï¼Œå°†å°è¯•åœæ­¢ç›¸å…³è¿›ç¨‹"
        lsof -ti :3001 | xargs -r kill -9
    fi
    
    # æ£€æŸ¥4173ç«¯å£ï¼ˆå‰ç«¯é¢„è§ˆï¼‰
    if lsof -i :4173 >/dev/null 2>&1; then
        log_warning "ç«¯å£ 4173 å·²è¢«å ç”¨ï¼Œå°†å°è¯•åœæ­¢ç›¸å…³è¿›ç¨‹"
        lsof -ti :4173 | xargs -r kill -9
    fi
    
    # æ£€æŸ¥8080ç«¯å£ï¼ˆNginxï¼‰
    if lsof -i :8080 >/dev/null 2>&1; then
        log_warning "ç«¯å£ 8080 å·²è¢«å ç”¨"
    fi
    
    log_success "ç«¯å£æ£€æŸ¥å®Œæˆ"
}

# å¯åŠ¨PM2æœåŠ¡
echo "å¯åŠ¨åç«¯å’Œå‰ç«¯æœåŠ¡..."
pm2 start ecosystem.config.js

# å¯åŠ¨Nginx
echo "å¯åŠ¨NginxæœåŠ¡..."
systemctl start nginx

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 3

# æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
echo ""
echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
pm2 list

echo ""
echo "ğŸ”Œ ç«¯å£çŠ¶æ€:"
netstat -tulpn | grep -E "(3001|4173|8080)"

echo ""
echo "âœ… ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼"
echo "ğŸ“± è®¿é—®åœ°å€: http://$(hostname -I | awk '{print $1}'):8080"
echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—: pm2 logs" 