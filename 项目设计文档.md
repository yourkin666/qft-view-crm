# 房源带看管理系统 - 项目设计文档

## 1. 项目概述

本项目旨在开发一个功能全面的房源带看管理系统。系统核心目标是集中管理来自多个渠道（包括人工录入、第三方 API 等）的客户带看预约记录，并实现精细化的权限控制和流程管理。系统将支持 PC 和移动端访问，确保经纪人可以随时随地高效处理业务。

## 2. 核心功能

### 2.1. 带看记录管理 ✅

- **列表展示**: 以列表形式清晰展示所有带看记录，关键信息一目了然（如客户、房源、状态、经纪人、时间等）。
- **筛选与搜索**: 提供多维度筛选功能（如下看状态、经纪人、来源渠道、创建时间等）和关键词搜索功能。
- **增删改查 (CRUD)**:
  - **手工录入**: 支持经纪人或管理员手动创建新的带看记录。
  - **编辑**: 支持修改已有记录的信息，如更新带看状态、修改备注等。
  - **查看详情**: 展示单条带看记录的全部信息。
  - **删除**: 允许按权限删除记录。
- **批量操作**: 支持批量更新记录状态，提高操作效率。

### 2.2. 多渠道数据接入 ✅

- **第三方 API 接入**: 提供标准、安全的 API 接口，供第三方渠道（如网站、小程序、AI 客服等）将带看数据自动推送到本系统。
- **手工录入**: 作为最基础的数据来源，保证任何线下或无法通过 API 接入的带看需求都能被录入系统。
- **API 密钥管理**: 完善的 API 密钥生成、管理和统计功能。

### 2.3. 权限管理 (RBAC) ✅

系统将采用基于角色的访问控制（RBAC）模型，预设以下核心角色：

- **超级管理员 (Admin)**: 拥有系统最高权限，可管理所有数据、用户和系统设置。
- **经纪人 (Agent)**: 核心使用角色。可以查看和管理分配给自己的带看记录，可以创建新的带看记录，但无法查看他人的记录。

### 2.4. 数据导出和报表功能 ✅

- **数据导出**: 支持 Excel 和 PDF 格式的数据导出，可按多种条件筛选导出数据。
- **高级统计分析**: 提供全面的统计分析功能，包括状态分布、来源分布、业务类型分布、30 天趋势分析等。
- **图表可视化**: 使用专业图表库展示统计数据，支持饼图、柱状图、折线图等多种展示方式。
- **经纪人表现统计**: 管理员可查看各经纪人的工作量统计。

### 2.5. 多端适配 🔄

- 系统前端将采用响应式设计，自动适配 PC、平板和手机等不同尺寸的屏幕，确保在各种设备上都有一致且良好的用户体验。

## 3. 技术选型

为了保证系统的稳定性、可扩展性和开发效率，采用以下技术栈：

- **后端**:

  - **框架**: **NestJS** (基于 Node.js 和 TypeScript)。
  - **数据库**: **MySQL 8.0**。
  - **ORM**: **Prisma**。
  - **认证**: **JWT (JSON Web Tokens)** + **Passport.js**。
  - **导出**: **ExcelJS** (Excel 导出功能)。

- **前端**:

  - **框架**: **React 19** (TypeScript)。
  - **UI 库**: **Ant Design 5.26**，提供高质量的 PC 端 UI 组件，并有较好的响应式支持。
  - **状态管理**: **Redux Toolkit**。
  - **构建工具**: **Vite 7**。
  - **图表**: **@ant-design/plots** (数据可视化)。

- **部署**:
  - **容器化**: **Docker**。
  - **Web 服务器**: **Nginx**。
- **包管理工具**: 采用 **pnpm** 进行统一的包管理。

## 4. 数据库设计

在您提供的 `qft_agent_viewing_records` 表基础上，为了实现完整的用户权限和数据管理，建议补充以下核心表：

### 4.1. 补充核心表

**1. 角色表 (`roles`)**
定义系统中的角色。需要在用户表之前创建。

```sql
CREATE TABLE `roles` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(50) NOT NULL UNIQUE COMMENT '角色名称 (admin, agent)',
  `description` VARCHAR(255) COMMENT '角色描述',
  PRIMARY KEY (`id`)
) COMMENT='角色表';
```

**2. 用户表 (`users`)**
用于存储系统用户信息，包括登录凭证和角色。

```sql
CREATE TABLE `users` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名 (用于登录)',
  `password` VARCHAR(255) NOT NULL COMMENT '哈希后的密码',
  `full_name` VARCHAR(100) COMMENT '姓名',
  `phone` VARCHAR(20) UNIQUE COMMENT '手机号',
  `role_id` INT NOT NULL COMMENT '角色ID',
  `is_active` BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否激活',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  FOREIGN KEY (`role_id`) REFERENCES `roles`(`id`)
) COMMENT='系统用户表';
```

_初始数据: (1, 'admin', '超级管理员'), (2, 'agent', '经纪人')_

**3. API 密钥表 (`api_keys`)**
用于管理和认证第三方渠道的接入。

```sql
CREATE TABLE `api_keys` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `channel_name` VARCHAR(100) NOT NULL COMMENT '渠道名称 (如: 官网, 微信小程序)',
  `api_key` VARCHAR(255) NOT NULL UNIQUE COMMENT 'API Key (公开的标识符)',
  `api_secret_hash` VARCHAR(255) NOT NULL COMMENT 'API Secret 的哈希值 (用于校验)',
  `is_active` BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否激活',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) COMMENT='第三方渠道API密钥表';
```

**4. 房源表 (`properties`)** (可选，建议)
为了数据规范化，建议将房源信息独立出来。

```sql
CREATE TABLE `properties` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT '房源ID',
  `name` VARCHAR(200) NOT NULL COMMENT '物业名称',
  `address` VARCHAR(500) COMMENT '详细地址',
  -- 可以添加更多房源相关的字段，如面积、价格、户型等
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) COMMENT='房源信息表';
```

### 4.2. 原有表结构调整与说明

- **`qft_agent_viewing_records` 表**:
  - 该表是系统的核心业务表，用于记录所有带看信息。
  - **建议调整**:
    - 表注释修改为: `COMMENT='房源带看记录表'`（当前为'AI Agent 租客带看记录表'）
    - `source` 字段的默认值修改为: `DEFAULT 'manual'`（当前为'ai_agent'）
    - 字段命名统一: 当前表使用 `tenant_name`，建议保持一致性，在系统中统一使用"租客"概念
  - **外键关联**:
    - `agent_id` 字段应修改为外键，关联 `users` 表的 `id`。
    - `housing_id` 字段可以考虑修改为外键，关联 `properties` 表的 `id`。

## 5. API 设计 (RESTful)

### 5.1. 统一响应结构

为了便于客户端处理，所有 API 接口都遵循统一的响应结构。

- **成功响应**:
  ```json
  {
    "success": true,
    "data": { ... }
  }
  ```
- **失败响应**:
  ```json
  {
    "success": false,
    "error": {
      "code": "SOME_ERROR_CODE",
      "message": "具体的错误信息"
    }
  }
  ```

### 5.2. 认证接口 (`/api/auth`) ✅

- `POST /login`: 用户登录。成功后返回 JWT Token。
- `POST /logout`: 用户登出。
- `GET /me`: 获取当前登录用户信息。

### 5.3. 带看记录接口 (`/api/viewing-records`) ✅

- `GET /`: 获取带看记录列表。
  - **Query Params**: `page`, `pageSize`, `status`, `agentId`, `source`, `search`。
  - **权限**: 管理员可看所有，经纪人仅看自己的。
- `POST /`: 创建一条新的带看记录。
- `GET /{id}`: 获取单条记录详情。
- `PUT /{id}`: 更新指定记录。
- `DELETE /{id}`: 删除指定记录（管理员权限）。
- `PATCH /batch-update`: 批量更新记录状态。
- `GET /statistics`: 获取基础统计数据。
- `GET /statistics/advanced`: 获取高级统计数据。

### 5.4. 公共数据接入接口 (`/api/public`) ✅

- `POST /viewing-records`: 外部渠道专用接口。
  - **认证**: 使用 API Key + Secret 进行请求头认证。
  - **Body**: 接收与 `qft_agent_viewing_records` 结构一致的数据。
- `GET /health`: 健康检查接口。

### 5.5. 用户管理接口 (`/api/users`) ✅ - (管理员权限)

- `GET /`: 获取用户列表。
- `POST /`: 创建新用户。
- `PUT /{id}`: 更新用户信息。
- `DELETE /{id}`: 删除用户。

### 5.6. API 密钥管理接口 (`/api/api-keys`) ✅ - (管理员权限)

- `GET /`: 获取 API 密钥列表。
- `POST /`: 创建新的 API 密钥。
- `PUT /{id}`: 更新 API 密钥信息。
- `DELETE /{id}`: 删除 API 密钥。
- `POST /{id}/regenerate-secret`: 重新生成密钥。

### 5.7. 数据导出接口 (`/api/export`) ✅

- `GET /viewing-records`: 导出带看记录数据。
  - **Query Params**: `format`, `status`, `agentId`, `source`, `businessType`, `dateFrom`, `dateTo`。
  - **Response**: 文件流（Excel 或 PDF）。

## 6. 开发计划（里程碑）

建议将项目分为四个主要阶段：

- **✅ 第一阶段：后端核心搭建 (已完成)**

  1.  ✅ 搭建项目框架（NestJS）。
  2.  ✅ 完成数据库设计并初始化。
  3.  ✅ 实现用户、角色模块，以及 JWT 认证和 RBAC 权限基础。
  4.  ✅ 实现带看记录的核心 CRUD API。

- **✅ 第二阶段：PC 端核心功能开发 (已完成)**

  1.  ✅ 搭建前端项目（React）。
  2.  ✅ 开发用户登录/登出页面。
  3.  ✅ 开发带看记录管理主界面（列表、筛选、搜索）。
  4.  ✅ 实现带看记录的创建、编辑、详情弹窗/页面。

- **✅ 第三阶段：高级功能与 API 完善 (已完成)**

  1.  ✅ 完成后端 RBAC 权限在每个 API 接口的精确应用。
  2.  ✅ 开发并测试对外的公共 API 接口 (`/api/public/viewing-records`)。
  3.  ✅ 开发用户管理、角色管理等管理员专属功能的前端界面。
  4.  ✅ 实现数据导出和报表功能（Excel/PDF）。
  5.  ✅ 开发高级统计分析功能和图表可视化。
  6.  ✅ 实现批量操作功能。
  7.  ✅ 完善 API 密钥管理系统。

- **🔄 第四阶段：移动端适配与测试 (计划中)**
  1.  🔄 全面检查并优化前端界面的响应式布局，确保移动端体验。
  2.  ⏳ 进行完整的端到端测试，修复 Bug。
  3.  ⏳ 准备部署文档，正式上线。

## 7. 环境要求

### 开发环境

- Node.js >= 18.18.0
- MySQL 8.0
- pnpm (推荐的包管理器)

### 前端快速启动

```bash
cd frontend
pnpm install
pnpm run dev
```

### 后端快速启动

```bash
cd backend
pnpm install
cp .env.example .env  # 配置数据库连接
npx prisma db push    # 创建数据库表
npx prisma db seed    # 插入初始数据
pnpm run start:dev    # 启动开发服务器
```

## 8. 项目结构

```
qft-view-crm/
├── backend/                 # 后端服务 (NestJS)
│   ├── src/
│   │   ├── auth/           # ✅ 认证模块
│   │   ├── users/          # ✅ 用户管理
│   │   ├── viewing-records/ # ✅ 带看记录管理
│   │   ├── api-keys/       # ✅ API密钥管理
│   │   ├── roles/          # ✅ 角色管理
│   │   ├── export/         # ✅ 数据导出
│   │   ├── public/         # ✅ 公共API
│   │   └── common/         # ✅ 共用模块
│   ├── prisma/             # ✅ 数据库Schema和种子数据
│   └── README.md
├── frontend/               # 前端应用 (React)
│   ├── src/
│   │   ├── components/     # ✅ 公共组件
│   │   ├── pages/          # ✅ 页面组件
│   │   ├── services/       # ✅ API服务
│   │   ├── store/          # ✅ 状态管理
│   │   └── types/          # ✅ TypeScript类型定义
│   └── README.md
└── 项目设计文档.md          # 详细设计文档
```

## 9. 技术栈

### 后端已完成

- ✅ **框架**: NestJS (Node.js + TypeScript)
- ✅ **数据库**: MySQL 8.0 + Prisma ORM
- ✅ **认证**: JWT + Passport.js
- ✅ **权限**: RBAC (基于角色的访问控制)
- ✅ **导出**: ExcelJS (Excel 导出)

### 前端已完成

- ✅ **框架**: React 19 (TypeScript)
- ✅ **构建工具**: Vite 7
- ✅ **UI 库**: Ant Design 5.26
- ✅ **状态管理**: Redux Toolkit
- ✅ **路由**: React Router Dom 7
- ✅ **HTTP 客户端**: Axios
- ✅ **图表**: @ant-design/plots
- ✅ **日期处理**: dayjs

## 10. 核心功能

### ✅ 已实现功能

#### 带看记录管理

- ✅ 完整的 CRUD 操作（创建、查看、编辑、删除）
- ✅ 多维度筛选和搜索
- ✅ 列表展示和详情查看
- ✅ 批量状态更新
- ✅ 状态流转管理

#### 用户权限管理

- ✅ 基于角色的访问控制(RBAC)
- ✅ JWT 令牌认证
- ✅ 用户管理（仅管理员）
- ✅ 接口级权限控制

#### 多渠道数据接入

- ✅ RESTful API 接口
- ✅ API 密钥管理
- ✅ 第三方系统集成
- ✅ 手工录入支持

#### 数据导出与报表

- ✅ Excel/PDF 格式导出
- ✅ 高级统计分析
- ✅ 图表可视化
- ✅ 趋势分析

#### 系统管理

- ✅ 系统配置管理
- ✅ 使用统计监控
- ✅ API 密钥管理
- ✅ 用户角色管理

## 11. 里程碑

- ✅ **2024-07** 第一阶段：后端核心搭建
- ✅ **2024-07** 第二阶段：PC 端核心功能开发
- ✅ **2024-07** 第三阶段：高级功能与 API 完善
- 🔄 **2024-07** 第四阶段：移动端适配与测试
